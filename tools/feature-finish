#!/usr/bin/env bash
set -euo pipefail

FEATURE_NAME="${1:-}"
if [[ -z "$FEATURE_NAME" ]]; then
  echo "Usage: tools/feature-finish <feature_name>"
  exit 1
fi

BRANCH="feature/${FEATURE_NAME// /-}"
CURRENT="$(git branch --show-current)"

if [[ "$CURRENT" != "$BRANCH" ]]; then
  echo "ERROR: You are on '$CURRENT' but expected '$BRANCH'."
  echo "Switch to the feature branch and try again:"
  echo "  git checkout $BRANCH"
  exit 1
fi

echo "==> Checking uncommitted changes..."
if [[ -n "$(git status --porcelain)" ]]; then
  echo "ERROR: Uncommitted changes exist. Commit or stash them before finishing."
  git status --porcelain
  exit 1
fi

echo "==> Fetching latest..."
git fetch origin

echo "==> Ensuring feature branch is up to date with origin (fast-forward only)..."
# If the remote has moved, this will fail; user must reconcile (rebase/merge) explicitly.
git pull --ff-only origin "$BRANCH" || true

echo "==> Rebasing feature branch onto latest main (recommended)..."
# Keep history clean and reduce merge conflicts in the PR.
git rebase origin/main || {
  echo "ERROR: Rebase failed due to conflicts."
  echo "Resolve conflicts, then run:"
  echo "  git rebase --continue"
  echo "Or abort with:"
  echo "  git rebase --abort"
  exit 1
}

echo "==> Running standard checks..."
if [[ -x "./tools/checks" ]]; then
  ./tools/checks
else
  echo "ERROR: ./tools/checks not found or not executable."
  echo "Fix with:"
  echo "  chmod +x tools/checks"
  exit 1
fi

echo "==> Pushing feature branch..."
git push origin "$BRANCH" || {
  echo "ERROR: Push failed."
  echo "If you rebased and the remote branch has older history, you may need:"
  echo "  git push --force-with-lease"
  exit 1
}

echo ""
echo "==> Next step: Merge via Pull Request (main is protected)."
echo "Open PR: base=main  compare=$BRANCH"
echo ""

# Optional: auto-create PR if GitHub CLI is installed and authenticated.
if command -v gh >/dev/null 2>&1; then
  echo "==> GitHub CLI (gh) detected. Creating PR (if one doesn't already exist)..."
  # Create PR; if it already exists, gh will print an error; we don't want to fail the script.
  gh pr create \
    --base main \
    --head "$BRANCH" \
    --title "$FEATURE_NAME" \
    --body "## Summary\n\n## Changes\n\n## Testing\n\n- ./tools/checks\n" \
    2>/dev/null || true

  echo "==> Opening PR in browser..."
  gh pr view --web 2>/dev/null || true
else
  echo "TIP: Install GitHub CLI to auto-create/open PRs: https://cli.github.com/"
fi

echo ""
echo "==> Done. Feature branch pushed; merge via PR once CI passes."
